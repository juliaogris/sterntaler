# `/vulnerability-scan` - Deep Vulnerability Analysis

> Comprehensive CVE scanning, dependency analysis, and code-level vulnerability detection

**Version:** 2.7.0
**Category:** Security
**Type:** Orchestration Command
**Estimated Duration:** 30-60 minutes (depending on depth)

---

## Overview

The `/vulnerability-scan` command performs deep vulnerability analysis focusing on known CVEs, dependency vulnerabilities, and code-level security issues. Unlike `/audit` (broad security assessment), this command specifically targets **known vulnerabilities** with CVE correlation, exploit database matching, and auto-remediation capabilities.

### Key Differences: `/audit` vs `/vulnerability-scan`

| Feature | `/audit` | `/vulnerability-scan` |
|---------|----------|----------------------|
| **Focus** | Broad security assessment | Known vulnerabilities |
| **Scope** | OWASP Top 10, compliance, infrastructure, pentesting | CVEs, dependency analysis, SAST |
| **Duration** | 2-4 hours | 30-60 minutes |
| **Agents** | 4-5 agents across 4 phases | 2-3 agents across 3 phases |
| **Output** | Comprehensive audit report | Vulnerability remediation list |
| **Auto-Fix** | No | Yes (optional) |
| **Best For** | Quarterly security reviews | Weekly/CI-CD vulnerability checks |

---

## Key Features

- ✅ **CVE Database Correlation** - NVD, GitHub Advisories, npm audit, pip-audit
- ✅ **Dependency Tree Analysis** - Identifies transitive vulnerabilities
- ✅ **Code Pattern Matching** - SAST for injection, XSS, crypto issues
- ✅ **Exploit Correlation** - Links CVEs to public exploits (Exploit-DB, Metasploit)
- ✅ **Auto-Remediation** - Optional automatic package upgrades
- ✅ **Severity Scoring** - CVSS v3.1 with contextual analysis
- ✅ **CI/CD Integration** - Fast scans suitable for pipelines

---

## Quick Start

### Basic Usage

```bash
# Standard deep scan (dependencies + code)
/vulnerability-scan

# Fast surface scan (dependencies only)
/vulnerability-scan --depth surface

# Exhaustive scan (includes exploit correlation)
/vulnerability-scan --depth exhaustive

# Auto-fix safe vulnerabilities
/vulnerability-scan --auto-fix
```

### Advanced Usage

```bash
# Only report critical vulnerabilities
/vulnerability-scan --severity critical

# Fast scan for CI/CD
/vulnerability-scan --depth surface --severity critical
```

---

## How It Works

### Phase 0: Scan Planning

**Dependency Detection:**
```
Detected Dependency Files:
- package.json, package-lock.json (npm)
- requirements.txt (Python)
- pom.xml (Maven)

Tech Stack:
- Languages: JavaScript, TypeScript, Python, Java
- Package Managers: npm, pip, Maven

Selected Scanners:
Phase 1 (Parallel - 3 agents):
  ✓ @dependency-auditor (CVE scanning)
  ✓ @npm-security-scanner (npm-specific analysis)
  ✓ @cve-deep-analyzer (exhaustive CVE correlation)

Phase 2 (Sequential):
  → @code-vulnerability-scanner (SAST analysis)

Phase 3 (Conditional):
  → @exploit-correlation-agent (only if critical CVEs found)

Estimated Duration: 45 minutes
Depth: deep

Proceed? (y/n)
```

---

### Phase 1: Parallel Dependency Scanning

**3 Agents Run Simultaneously:**
- `@dependency-auditor` - Query NVD, GitHub Advisories
- `@npm-security-scanner` - npm audit + package-specific analysis
- `@cve-deep-analyzer` - Deep CVE correlation (if exhaustive mode)

**Analysis:**
```
Scanning 156 dependencies (42 direct, 114 transitive)...

Found vulnerabilities:
- lodash@4.17.15: CVE-2024-12345 (Prototype Pollution) - CRITICAL
- express@4.17.1: CVE-2024-23456 (RCE) - HIGH
- axios@0.21.1: CVE-2024-34567 (SSRF) - HIGH
- yargs-parser@20.2.0: CVE-2024-45678 (Arbitrary Code Execution) - MEDIUM
... 8 more vulnerabilities
```

**Auto-Created Todos:**
```bash
/todo-add "Upgrade lodash to 4.17.21 to fix CVE-2024-12345 (Prototype Pollution)"
/todo-add "Upgrade express to 4.18.0 to fix CVE-2024-23456 (RCE) - REVIEW BREAKING CHANGES"
/todo-add "Upgrade axios to 0.21.4 to fix CVE-2024-34567 (SSRF)"
```

**Output:**
```
Phase 1 Complete (20 minutes)
- @dependency-auditor: 12 CVEs found
- @npm-security-scanner: 8 npm-specific issues
- @cve-deep-analyzer: 3 critical CVEs with high CVSS scores

Todos Created: 12
Reports: .tresor/vuln-scan-2025-11-19/phase-1-*.md
```

---

### Phase 2: Code Pattern Analysis

**Agent:**
- `@code-vulnerability-scanner` (SAST)

**Analyzes Source Code For:**
1. **Injection Vulnerabilities**:
   - SQL injection (unsanitized database queries)
   - Command injection (shell execution)
   - Template injection

2. **XSS Vulnerabilities**:
   - Reflected XSS
   - Stored XSS
   - DOM-based XSS

3. **Authentication/Authorization**:
   - Hardcoded credentials
   - Weak crypto
   - Missing auth checks

4. **Data Exposure**:
   - API keys in code
   - Secrets in logs
   - PII without encryption

**Example Findings:**
```
Code Vulnerabilities Found:

1. SQL Injection - src/api/users.ts:45-67
   Pattern: Unsanitized user input in SQL query
   Severity: CRITICAL
   Fix: Use parameterized queries
   Code:
     // Vulnerable:
     db.query(`SELECT * FROM users WHERE id = ${req.params.id}`)

     // Fixed:
     db.query('SELECT * FROM users WHERE id = ?', [req.params.id])

2. Hardcoded API Key - src/config/aws.ts:8
   Pattern: AWS access key in source code
   Severity: CRITICAL
   Fix: Use environment variables + AWS Secrets Manager

3. XSS Vulnerability - src/components/UserProfile.tsx:89
   Pattern: Unescaped user input in JSX
   Severity: HIGH
   Fix: Use DOMPurify or React's automatic escaping
```

**Output:**
```
Phase 2 Complete (15 minutes)
- @code-vulnerability-scanner: 8 vulnerabilities found
  - 2 CRITICAL (SQL injection, hardcoded secrets)
  - 3 HIGH (XSS)
  - 3 MEDIUM

Todos Created: 8 (total: 20)
Reports: .tresor/vuln-scan-2025-11-19/phase-2-code-scanner.md
```

---

### Phase 3: Exploit Correlation (Conditional)

**Only Runs If:**
- Depth is `exhaustive`
- Critical CVEs found in Phase 1-2

**Agent:**
- `@exploit-correlation-agent`

**Queries Exploit Databases:**
- Exploit-DB
- Metasploit Modules
- PacketStorm
- GitHub PoC repositories
- Nuclei templates

**Analysis:**
```
Correlating 2 critical CVEs with exploit databases...

CVE-2024-12345 (lodash Prototype Pollution):
  ✓ Public PoC: github.com/researcher/lodash-exploit
  ✓ Exploit-DB: EDB-ID-51234
  ✓ Complexity: LOW
  ✓ Authentication Required: NO
  → HIGH RISK (public exploit, low complexity)

CVE-2024-23456 (Express RCE):
  ✓ Metasploit Module: exploit/multi/http/express_rce
  ✓ Nuclei Template: express-cve-2024-23456.yaml
  ✓ Complexity: MEDIUM
  ✓ Authentication Required: NO
  → HIGH RISK (Metasploit module exists)
```

**Output:**
```
Phase 3 Complete (10 minutes)
- @exploit-correlation-agent: 2 CVEs have public exploits
  - Both rated HIGH RISK
  - Immediate patching recommended

Todos Created: 0 (todos already created in Phase 1)
Reports: .tresor/vuln-scan-2025-11-19/phase-3-exploit-correlation.md
```

---

## Final Output

### Consolidated Report

**Location:** `.tresor/vuln-scan-2025-11-19-150322/final-report.md`

```markdown
# Vulnerability Scan Report

**Scan ID**: vuln-scan-2025-11-19-150322
**Depth**: deep
**Duration**: 45 minutes
**Status**: Complete

## Summary

### Dependencies
- Scanned: 156 (42 direct, 114 transitive)
- Vulnerable: 12
  - Critical: 2
  - High: 5
  - Medium: 4
  - Low: 1

### Code Analysis
- Files Scanned: 247
- Vulnerabilities: 8
  - Critical: 2 (SQL injection, hardcoded secrets)
  - High: 3 (XSS)
  - Medium: 3

### Exploit Correlation
- CVEs with public exploits: 2
- High-risk exploits: 2 (low complexity, no auth required)

## Top 5 Critical Vulnerabilities

1. CVE-2024-12345 - Prototype Pollution in lodash@4.17.15
   - CVSS: 9.1 (CRITICAL)
   - Exploit: ✅ Public PoC (low complexity)
   - Fix: Upgrade to lodash@4.17.21
   - Breaking: No
   - Command: `npm install lodash@4.17.21`
   - Todo: #vuln-001

2. SQL Injection - src/api/users.ts:45-67
   - Severity: CRITICAL
   - Exploit: Manual exploitation possible
   - Fix: Use parameterized queries (see code example)
   - Time: ~4 hours
   - Todo: #vuln-002

3. CVE-2024-23456 - RCE in Express@4.17.1
   - CVSS: 8.6 (HIGH)
   - Exploit: ✅ Metasploit module
   - Fix: Upgrade to Express@4.18.0
   - Breaking: ⚠️ Yes (review changelog)
   - Command: `npm install express@4.18.0`
   - Todo: #vuln-003

4. Hardcoded AWS API Key - src/config/aws.ts:8
   - Severity: CRITICAL
   - Fix: Environment variables + AWS Secrets Manager
   - Time: ~1 hour
   - Todo: #vuln-004

5. XSS - src/components/UserProfile.tsx:89
   - Severity: HIGH
   - Fix: Sanitize HTML output
   - Time: ~2 hours
   - Todo: #vuln-005

## Auto-Fix Available

3 vulnerabilities can be auto-fixed (no breaking changes):
```bash
# Run with --auto-fix to automatically apply these upgrades:
npm install lodash@4.17.21  # Fixes CVE-2024-12345
npm install axios@0.21.4     # Fixes CVE-2024-34567
npm install yargs-parser@20.2.9  # Fixes CVE-2024-45678
```

## Remediation Roadmap

### Immediate (< 1 day) - 6.5 hours
- [ ] Upgrade lodash (30m) - NO BREAKING CHANGES
- [ ] Fix SQL injection (4h)
- [ ] Remove hardcoded API key (1h)
- [ ] Upgrade axios (30m) - NO BREAKING CHANGES
- [ ] Upgrade yargs-parser (30m) - NO BREAKING CHANGES

### Short-term (1-7 days) - 16 hours
- [ ] Upgrade Express - REVIEW BREAKING CHANGES (8h)
- [ ] Fix 3 XSS vulnerabilities (6h)
- [ ] Implement secrets manager (2h)

### Long-term (> 7 days)
- [ ] Input validation framework (16h)
- [ ] Automated dependency scanning in CI/CD (4h)
- [ ] Enable Dependabot/Renovate (2h)

## Next Steps

1. Run `/vulnerability-scan --auto-fix` to automatically upgrade 3 safe packages
2. Fix 2 critical code vulnerabilities manually (5 hours)
3. Review Express upgrade path (breaking changes detected)
4. Run `/todo-check` to systematically address all findings
5. Schedule weekly vulnerability scans
```

---

## Example Workflows

### Workflow 1: Weekly Vulnerability Check

```bash
# Step 1: Run standard scan
/vulnerability-scan

# Step 2: Auto-fix safe vulnerabilities
/vulnerability-scan --auto-fix
# → Automatically upgrades lodash, axios, yargs-parser
# → Runs tests to verify no breakage
# → Creates commit

# Step 3: Review manual fixes needed
/todo-check
# → 5 critical/high todos require manual fixes

# Step 4: Fix critical issues
# [Work on SQL injection, hardcoded secrets]

# Step 5: Re-scan to verify fixes
/vulnerability-scan --depth surface
# → Confirms fixes, no new vulnerabilities
```

---

### Workflow 2: CI/CD Integration

```bash
# In CI/CD pipeline:
/vulnerability-scan --depth surface --severity critical

# Fail build if critical vulnerabilities found
# Exit code: 1 if critical found, 0 if clean
```

**GitHub Actions Example:**
```yaml
- name: Security Scan
  run: |
    /vulnerability-scan --depth surface --severity critical
  continue-on-error: false  # Fail build on critical vulns
```

---

### Workflow 3: Pre-Deployment Check

```bash
# Before deploying to production:

# Step 1: Deep scan
/vulnerability-scan --depth deep

# Step 2: Review findings
cat .tresor/vuln-scan-*/final-report.md

# Step 3: Decision point
if [ critical_vulns > 0 ]; then
  echo "❌ Critical vulnerabilities found - DEPLOYMENT BLOCKED"
  exit 1
else
  echo "✅ No critical vulnerabilities - safe to deploy"
fi
```

---

### Workflow 4: Exploit-Aware Scanning

```bash
# Exhaustive scan with exploit correlation
/vulnerability-scan --depth exhaustive

# Output shows which CVEs have public exploits:
# ✅ CVE-2024-12345: Public PoC available (HIGH RISK)
# ✅ CVE-2024-23456: Metasploit module exists (HIGH RISK)

# Prioritize fixes based on exploit availability
/todo-check
# → Todos sorted by exploit availability + CVSS score
```

---

## Command Options

### `--depth` (Scan Depth)

**Options:** `surface`, `deep`, `exhaustive` (default: `deep`)

```bash
/vulnerability-scan --depth surface
# ✓ Fast (10-15 minutes)
# ✓ Dependency CVE scanning only
# ✓ Suitable for CI/CD
# ✗ No code analysis
# ✗ No exploit correlation

/vulnerability-scan --depth deep
# ✓ Comprehensive (30-45 minutes)
# ✓ Dependency + code analysis
# ✓ CVSS scoring
# ✗ No exploit correlation

/vulnerability-scan --depth exhaustive
# ✓ Maximum coverage (45-60 minutes)
# ✓ Everything in 'deep' mode
# ✓ Exploit database correlation
# ✓ Public PoC identification
```

### `--auto-fix` (Automatic Remediation)

**Enable automatic package upgrades** for vulnerabilities with:
- No breaking changes
- Clear upgrade path
- Tests pass after upgrade

```bash
/vulnerability-scan --auto-fix

# Automatically upgrades:
✓ lodash: 4.17.15 → 4.17.21 (CVE-2024-12345)
✓ axios: 0.21.1 → 0.21.4 (CVE-2024-34567)
✓ Tests passed
✓ Commit created: fix(security): upgrade 2 vulnerable packages

# Skips (requires manual review):
✗ Express: 4.17.1 → 4.18.0 (breaking changes)
✗ React: 17.0.2 → 18.2.0 (major version)
```

### `--severity` (Filter by Severity)

**Options:** `critical`, `high`, `all` (default: `all`)

```bash
/vulnerability-scan --severity critical
# Only reports CRITICAL vulnerabilities (CVSS >= 9.0)

/vulnerability-scan --severity high
# Reports CRITICAL + HIGH (CVSS >= 7.0)

/vulnerability-scan --severity all
# Reports all severities (default)
```

---

## Integration with Tresor Workflow

### Automatic `/todo-add`

Every critical/high vulnerability creates a structured todo:

```markdown
## Vulnerability Scan Findings - 2025-11-19 15:03

- **Upgrade lodash to fix CVE-2024-12345** - Prototype pollution vulnerability allowing arbitrary code execution. **Problem:** lodash@4.17.15 has critical CVE. **Files:** package.json:23. **Solution:** Run `npm install lodash@4.17.21` (no breaking changes).

- **Fix SQL injection in users API** - User input not sanitized in database query. **Problem:** Attacker can execute arbitrary SQL. **Files:** src/api/users.ts:45-67. **Solution:** Use parameterized queries: `db.query('SELECT * FROM users WHERE id = ?', [req.params.id])`.
```

### Automatic `/prompt-create`

Complex fixes generate expert prompts:

```bash
# Auto-generated for breaking changes:
./prompts/002-express-4-to-5-migration.md

# Prompt suggests:
- @backend-architect (migration strategy)
- @test-engineer (regression testing)
- @devops-engineer (deployment rollback plan)

# Run with:
/prompt-run 002
```

### `/todo-check` Integration

```bash
/todo-check

# Output:
Outstanding Todos:

1. [CRITICAL] Upgrade lodash to fix CVE-2024-12345 (vuln-2025-11-19)
   → Auto-fixable: YES (run /vulnerability-scan --auto-fix)
   → Suggested: @dependency-auditor

2. [CRITICAL] Fix SQL injection in users API (vuln-2025-11-19)
   → Suggested: @security-auditor (confidence: 95%)

3. [HIGH] Upgrade Express (vuln-2025-11-19)
   → Breaking changes detected
   → Suggested: Use /prompt-run 002 for migration plan
```

---

## Supported Technologies

### Package Managers
- **JavaScript:** npm, yarn, pnpm
- **Python:** pip, pipenv, poetry
- **Java:** Maven, Gradle
- **Go:** go modules
- **Rust:** Cargo
- **Ruby:** Bundler
- **PHP:** Composer
- **.NET:** NuGet

### CVE Databases
- National Vulnerability Database (NVD)
- GitHub Security Advisories
- npm audit, pip-audit, bundler-audit
- Snyk Vulnerability DB
- OSV (Open Source Vulnerabilities)

### Exploit Databases (exhaustive mode)
- Exploit-DB
- Metasploit Modules
- PacketStorm Security
- GitHub PoC repositories
- Nuclei Templates
- Vulners

---

## FAQ

### Q: How is this different from `/audit`?

**A:**
- `/audit`: Comprehensive security audit (OWASP Top 10, compliance, infrastructure, pentesting)
- `/vulnerability-scan`: Focused on **known vulnerabilities** (CVEs, dependency issues)

Use `/audit` quarterly, `/vulnerability-scan` weekly.

### Q: Can I run this in CI/CD?

**A:** Yes! Use:
```bash
/vulnerability-scan --depth surface --severity critical
# Fast (10-15 min), only critical issues, fail build if found
```

### Q: What does `--auto-fix` change?

**A:** Auto-fixes **only safe upgrades**:
- ✅ Patch/minor version updates with no breaking changes
- ✅ Tests must pass after upgrade
- ❌ Skips major version upgrades
- ❌ Skips if breaking changes detected

### Q: How often should I scan?

**A:**
- **Weekly:** `/vulnerability-scan --depth surface`
- **Pre-deployment:** `/vulnerability-scan --depth deep`
- **Quarterly:** `/vulnerability-scan --depth exhaustive`

---

## Troubleshooting

### Issue: "Package manager not found"

**Cause:** Package manager executable not in PATH

**Solution:**
```bash
# Ensure package manager is installed:
npm --version  # For npm
pip --version  # For Python
mvn --version  # For Maven
```

---

### Issue: "CVE database unavailable"

**Cause:** Network issue or NVD API rate limit

**Solution:**
- Scan uses cached CVE data (may be outdated)
- Wait and retry
- Check internet connection

---

### Issue: Auto-fix tests failing

**Cause:** Package upgrade broke tests

**Solution:**
- Auto-fix automatically rolls back changes
- Review breaking changes manually
- Use `/prompt-create` for complex migrations

---

## See Also

- **[/audit Command](../audit/)** - Comprehensive security audit
- **[Dependency Auditor Agent](../../../subagents/core/dependency-auditor/)** - CVE scanning specialist
- **[Security Auditor Agent](../../../subagents/core/security-auditor/)** - General security agent

---

**Version:** 2.7.0
**Last Updated:** November 19, 2025
**Category:** Security
**License:** MIT
**Author:** Alireza Rezvani
